<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.happyhouse.model.mapper.HouseMapMapper">

	<select id="getSido" resultType="sidoGugunCodeDto">
		select left(sidoCode,2) sidoCode, sidoName
		from sidocode
		order by sidoCode
	</select>
	
	<select id="getGugunInSido" parameterType="string" resultType="sidoGugunCodeDto">
		select left(gugunCode,5) gugunCode, gugunName
		from guguncode
		where left(gugunCode,2) = #{sido}
		order by gugunCode
	</select>
	
	<select id="getDongInGugun" parameterType="string" resultType="houseInfoDto">
		select distinct dong, dongCode
		from houseinfo
		where left(dongCode, 5) = #{gugun}
		order by dong
	</select>
	
	<select id="getAptInfo" parameterType="string" resultType="houseInfoDto">
		select distinct si.sidoName, gu.gugunName, dong
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode}
	</select>
	
	<update id="addSearchCnt" parameterType="string">
		update searchapt
			set cnt = cnt + 1
		where dongcode = #{aptcode};
	</update>
	
	<select id="searchApt" resultType="aptSearchCnt">
		select d.dongCode, concat(d.sidoName, ' ', d.gugunName, ' ', d.dongName) address, s.cnt
			from dongcode d, searchapt s
		where d.dongCode = s.dongcode
		order by s.cnt desc
		limit 10;
	</select>
	
	<select id="getAptInDong" parameterType="string" resultType="houseInfoDto">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, h.jibun, h.lat, h.lng, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{dong} 
		order by apartmentName
	</select>
	
	<select id="getAptDetail" parameterType="string" resultType="houseDetail">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice,
                (select dealYear from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentYear,
                (select dealMonth from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentMonth,
                (select dealDay from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentDay,
                (select area from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) area,
                (select floor from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) floor
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode} 
        order by apartmentName;
	</select>
	
	<select id="getAptDetailDesc" parameterType="string" resultType="houseDetail">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice,
                (select dealYear from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentYear,
                (select dealMonth from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentMonth,
                (select dealDay from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentDay,
                (select area from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) area,
                (select floor from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) floor
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode} 
        order by apartmentName DESC;
	</select>
	
	<select id="getAptDetailYearSort" parameterType="string" resultType="houseDetail">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice,
                (select dealYear from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentYear,
                (select dealMonth from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentMonth,
                (select dealDay from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentDay,
                (select area from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) area,
                (select floor from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) floor
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode} 
        order by buildyear;
	</select>
	
	<select id="getAptDetailYearSortDesc" parameterType="string" resultType="houseDetail">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice,
                (select dealYear from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentYear,
                (select dealMonth from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentMonth,
                (select dealDay from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentDay,
                (select area from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) area,
                (select floor from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) floor
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode} 
        order by buildyear DESC;
	</select>
	
	<select id="getAptDetailPriceSort" parameterType="string" resultType="houseDetail">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice,
                (select dealYear from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentYear,
                (select dealMonth from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentMonth,
                (select dealDay from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentDay,
                (select area from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) area,
                (select floor from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) floor
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode} 
        order by recentPrice;
	</select>
	
	<select id="getAptDetailPriceSortDesc" parameterType="string" resultType="houseDetail">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice,
                (select dealYear from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentYear,
                (select dealMonth from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentMonth,
                (select dealDay from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentDay,
                (select area from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) area,
                (select floor from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) floor
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode} 
        order by recentPrice DESC;
	</select>
	
	<select id="getAptDetailAreaSort" parameterType="string" resultType="houseDetail">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice,
                (select dealYear from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentYear,
                (select dealMonth from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentMonth,
                (select dealDay from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentDay,
                (select area from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) area,
                (select floor from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) floor
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode} 
        order by area;
	</select>
	
	<select id="getAptDetailAreaSortDesc" parameterType="string" resultType="houseDetail">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice,
                (select dealYear from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentYear,
                (select dealMonth from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentMonth,
                (select dealDay from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentDay,
                (select area from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) area,
                (select floor from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) floor
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where dongCode = #{aptcode} 
        order by area DESC;
	</select>
	
	<select id="getAptWord" parameterType="string" resultType="houseInfoDto">
		select h.aptCode, h.apartmentName, h.buildyear, h.dongCode, h.dong, h.jibun, h.lat, h.lng, si.sidoname, gu.gugunname,
				(select dealAmount from housedeal where aptCode = h.aptCode and no = (select max(no) from housedeal where aptCode = h.aptCode)) recentPrice
		from houseinfo h
		left join sidocode si
		on left(h.dongcode,2) = left(si.sidocode,2)
		left join guguncode gu
		on left(h.dongcode,5) = left(gu.guguncode,5)
		where apartmentName like concat('%', #{apartmentName}, '%')
		order by apartmentName
	</select>
	
	<insert id="insertBookmark" parameterType="bookmark">
		insert into bookmark
		values (#{userid}, #{aptCode})
	</insert>
	
	<delete id="deleteBookmark" parameterType="bookmark">
		delete from bookmark
		where userid = #{userid} and aptCode = #{aptCode}
	</delete>
	
	<select id="selectBookmark" parameterType="bookmark" resultType="bookmark">
		select * from bookmark
		where userid = #{userid} and aptCode = #{aptCode}
	</select>
	
</mapper>